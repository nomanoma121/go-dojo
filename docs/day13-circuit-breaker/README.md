# Day 13: Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³

## ğŸ¯ æœ¬æ—¥ã®ç›®æ¨™ (Today's Goal)

å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒè‡ªèº«ã®ã‚·ã‚¹ãƒ†ãƒ ã«æ³¢åŠã™ã‚‹ã®ã‚’é˜²ãCircuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®è€éšœå®³æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å­¦ç¿’ã—ã¾ã™ã€‚

## ğŸ“– è§£èª¬ (Explanation)

### Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯

Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®å‘¼ã³å‡ºã—ã‚’ç›£è¦–ã—ã€å¤±æ•—ãŒä¸€å®šã®é–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã«è‡ªå‹•çš„ã«å›è·¯ã‚’ã€Œé–‹ãã€ã“ã¨ã§ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®éšœå®³ã‚’é˜²ããƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

### ãªãœå¿…è¦ãªã®ã‹ï¼Ÿ

1. **éšœå®³ã®é€£é–ã‚’é˜²ã**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒè‡ªåˆ†ã®ã‚·ã‚¹ãƒ†ãƒ ã«æ³¢åŠã™ã‚‹ã“ã¨ã‚’é˜²ãã¾ã™
2. **ãƒªã‚½ãƒ¼ã‚¹ã®ä¿è­·**: å¤±æ•—ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹å‘¼ã³å‡ºã—ã‚’é¿ã‘ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã‚„ãƒ¡ãƒ¢ãƒªã‚’ç„¡é§„ã«æ¶ˆè²»ã—ã¾ã›ã‚“
3. **é«˜é€Ÿãªå¤±æ•—**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹é–“ã¯å³åº§ã«å¤±æ•—ã•ã›ã€å¿œç­”æ™‚é–“ã‚’çŸ­ç¸®ã—ã¾ã™
4. **è‡ªå‹•å›å¾©**: ã‚µãƒ¼ãƒ“ã‚¹ãŒå¾©æ—§ã—ãŸéš›ã®è‡ªå‹•æ¤œçŸ¥ã¨å›å¾©æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™

### Circuit Breakerã®3ã¤ã®çŠ¶æ…‹

#### 1. ClosedçŠ¶æ…‹ï¼ˆé€šå¸¸çŠ¶æ…‹ï¼‰
- ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«è»¢é€
- æˆåŠŸãƒ»å¤±æ•—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
- å¤±æ•—ç‡ãŒé–¾å€¤ã‚’è¶…ãˆã‚‹ã¨OpençŠ¶æ…‹ã«ç§»è¡Œ

#### 2. OpençŠ¶æ…‹ï¼ˆå›è·¯é–‹æ”¾çŠ¶æ…‹ï¼‰
- ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å³åº§ã«å¤±æ•—ã•ã›ã‚‹
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®å‘¼ã³å‡ºã—ã¯è¡Œã‚ãªã„
- ä¸€å®šæ™‚é–“çµŒéå¾Œã«Half-OpençŠ¶æ…‹ã«ç§»è¡Œ

#### 3. Half-OpençŠ¶æ…‹ï¼ˆå›å¾©è©¦è¡ŒçŠ¶æ…‹ï¼‰
- é™å®šæ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«è»¢é€
- æˆåŠŸã™ã‚Œã°ClosedçŠ¶æ…‹ã«æˆ»ã‚‹
- å¤±æ•—ã™ã‚Œã°OpençŠ¶æ…‹ã«æˆ»ã‚‹

### å®Ÿè£…ã«ãŠã‘ã‚‹è€ƒæ…®ç‚¹

#### ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§
è¤‡æ•°ã®goroutineã‹ã‚‰åŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãŸã‚ã€å†…éƒ¨çŠ¶æ…‹ã®ç®¡ç†ã«ã¯é©åˆ‡ãªåŒæœŸå‡¦ç†ãŒå¿…è¦ã§ã™ã€‚

#### çµ±è¨ˆã®ç®¡ç†
å¤±æ•—ç‡ã®è¨ˆç®—ã«ã¯æ»‘å‹•çª“ï¼ˆsliding windowï¼‰ã‚’ä½¿ç”¨ã—ã€ç›´è¿‘ã®ä¸€å®šæœŸé–“ã§ã®æˆåŠŸãƒ»å¤±æ•—ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
å„çŠ¶æ…‹ã§ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’é©åˆ‡ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- OpençŠ¶æ…‹ã§ã®å¾…æ©Ÿæ™‚é–“
- Half-OpençŠ¶æ…‹ã§ã®è©¦è¡Œæ™‚é–“

## ğŸ“ èª²é¡Œ (The Problem)

ä»¥ä¸‹ã®æ§‹é€ ä½“ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ã€Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ï¼š

```go
// CircuitBreakerState represents the current state of the circuit breaker
type CircuitBreakerState int

const (
    StateClosed CircuitBreakerState = iota
    StateOpen
    StateHalfOpen
)

// CircuitBreaker implements the circuit breaker pattern
type CircuitBreaker struct {
    maxFailures    int           // å¤±æ•—å›æ•°ã®é–¾å€¤
    resetTimeout   time.Duration // OpençŠ¶æ…‹ã‹ã‚‰Half-Openã«ç§»è¡Œã™ã‚‹æ™‚é–“
    halfOpenMaxCalls int         // Half-OpençŠ¶æ…‹ã§ã®æœ€å¤§è©¦è¡Œå›æ•°
    
    state         CircuitBreakerState
    failures      int
    lastFailTime  time.Time
    halfOpenCalls int
    
    mutex sync.RWMutex
}

// Settings for circuit breaker configuration
type Settings struct {
    MaxFailures      int
    ResetTimeout     time.Duration
    HalfOpenMaxCalls int
}
```

### å®Ÿè£…ã™ã¹ããƒ¡ã‚½ãƒƒãƒ‰

1. **NewCircuitBreaker**: æ–°ã—ã„Circuit Breakerã‚’ä½œæˆ
2. **Call**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ã‚’ãƒ©ãƒƒãƒ—
3. **GetState**: ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
4. **GetCounts**: çµ±è¨ˆæƒ…å ±ã‚’å–å¾—

## âœ… æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹• (Expected Behavior)

æ­£ã—ãå®Ÿè£…ã•ã‚ŒãŸCircuit Breakerã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‹•ä½œã—ã¾ã™ï¼š

### ClosedçŠ¶æ…‹ã§ã®å‹•ä½œ
```
Request -> [CB: Closed] -> External Service -> Success/Failure
å¤±æ•—å›æ•°ãŒé–¾å€¤æœªæº€: ãã®ã¾ã¾å‡¦ç†ç¶™ç¶š
å¤±æ•—å›æ•°ãŒé–¾å€¤åˆ°é”: OpençŠ¶æ…‹ã«ç§»è¡Œ
```

### OpençŠ¶æ…‹ã§ã®å‹•ä½œ
```
Request -> [CB: Open] -> Immediate Failure (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ)
ä¸€å®šæ™‚é–“çµŒé: Half-OpençŠ¶æ…‹ã«ç§»è¡Œ
```

### Half-OpençŠ¶æ…‹ã§ã®å‹•ä½œ
```
Request -> [CB: Half-Open] -> External Service (é™å®šçš„)
æˆåŠŸ: ClosedçŠ¶æ…‹ã«å¾©å¸°
å¤±æ•—: OpençŠ¶æ…‹ã«æˆ»ã‚‹
```

## ğŸ’¡ ãƒ’ãƒ³ãƒˆ (Hints)

1. **çŠ¶æ…‹ç®¡ç†**: `sync.RWMutex`ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªçŠ¶æ…‹ç®¡ç†ã‚’è¡Œã„ã¾ã—ã‚‡ã†
2. **æ™‚é–“ç®¡ç†**: `time.Since()`ã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’åˆ¤å®šã—ã¾ã—ã‚‡ã†
3. **çµ±è¨ˆç®¡ç†**: æˆåŠŸãƒ»å¤±æ•—ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’é©åˆ‡ã«æ›´æ–°ã—ã¾ã—ã‚‡ã†
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: Circuit BrekerãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã®å°‚ç”¨ã‚¨ãƒ©ãƒ¼ã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†
5. **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: æ™‚é–“ã«ä¾å­˜ã™ã‚‹å‡¦ç†ã¯å¤–éƒ¨ã‹ã‚‰åˆ¶å¾¡å¯èƒ½ã«ã—ã¾ã—ã‚‡ã†

## å‚è€ƒå®Ÿè£…ä¾‹

```go
// åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹
cb := NewCircuitBreaker(Settings{
    MaxFailures:      3,
    ResetTimeout:     5 * time.Second,
    HalfOpenMaxCalls: 2,
})

// å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ã®ãƒ©ãƒƒãƒ—
result, err := cb.Call(func() (interface{}, error) {
    return externalServiceCall()
})
```

## ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰

- âœ… åŸºæœ¬å®Ÿè£…: 3ã¤ã®çŠ¶æ…‹ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- âœ… ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•: ä¸¦è¡Œã‚¢ã‚¯ã‚»ã‚¹ã§æ­£ã—ãå‹•ä½œã™ã‚‹
- âœ… çµ±è¨ˆç®¡ç†: å¤±æ•—ç‡ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹
- âœ… è‡ªå‹•å›å¾©: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®è‡ªå‹•å›å¾©ãŒå‹•ä½œã™ã‚‹
- âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OpençŠ¶æ…‹ã§é©åˆ‡ã«å¤±æ•—ã™ã‚‹

## å®Ÿè¡Œæ–¹æ³•

```bash
go test -v
go test -race
go test -bench=.
```

## å‚è€ƒè³‡æ–™

- [Circuit Breaker Pattern - Martin Fowler](https://martinfowler.com/bliki/CircuitBreaker.html)
- [Hystrix Documentation](https://github.com/Netflix/Hystrix/wiki)
- [Go Concurrency Patterns](https://blog.golang.org/concurrency-patterns)